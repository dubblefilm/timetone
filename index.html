<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timetone</title>
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Avenir', 'Avenir Next', 'Nunito Sans', 'Helvetica Neue', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      transition: background-color 2s ease;
      overflow: hidden;
    }

    /* --- Logo button --- */
    .logo-btn {
      position: fixed;
      border: none;
      background: none;
      cursor: pointer;
      padding: 0;
      z-index: 10;
      transition: top 0.6s ease, left 0.6s ease, width 0.6s ease, height 0.6s ease, transform 0.6s ease;
      top: calc(50% - 2.5rem);
      left: calc(50% - 2.5rem);
      transform: rotate(0deg);
      width: 5rem;
      height: 5rem;
    }

    .logo-btn img {
      width: 100%;
      height: 100%;
      display: block;
    }

    body.expanded .logo-btn {
      top: 1.2rem;
      left: 1.2rem;
      transform: rotate(720deg);
      width: 2.5rem;
      height: 2.5rem;
    }

    /* --- Main content --- */
    .container {
      text-align: center;
      padding: 3rem 4rem;
      transition: color 1s ease, opacity 0.5s ease, transform 0.5s ease;
      opacity: 0;
      transform: scale(0.9);
      pointer-events: none;
    }

    body.expanded .container {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
      transition: color 1s ease, opacity 0.5s ease 0.2s, transform 0.5s ease 0.2s;
    }

    .time {
      font-size: 5rem;
      font-weight: bold;
      letter-spacing: 0.15em;
      margin-right: -0.15em;
      line-height: 1.1;
    }

    .date {
      font-size: 1.2rem;
      margin-top: 0.5rem;
      opacity: 0.8;
      letter-spacing: 0.2em;
      margin-right: -0.2em;
      text-transform: uppercase;
    }

    .colour-info {
      margin-top: 1.8rem;
      display: flex;
      gap: 2.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .colour-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.4rem;
    }

    .colour-label {
      font-size: 0.7rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      opacity: 0.6;
    }

    .colour-value {
      font-size: 1.3rem;
      font-weight: bold;
      letter-spacing: 0.08em;
    }

    .swatch-row {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 2rem;
    }

    .swatch {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      transition: background-color 2s ease;
      opacity: 0.5;
    }

    .mapping {
      margin-top: 2rem;
      font-size: 0.65rem;
      opacity: 0.4;
      letter-spacing: 0.15em;
      line-height: 1.8;
    }

    .btn-row {
      margin-top: 1.8rem;
      display: flex;
      gap: 0.8rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .travel-btn, .capture-btn {
      padding: 0.6rem 1.6rem;
      border: 1.5px solid currentColor;
      border-radius: 2rem;
      background: none;
      color: inherit;
      font-family: 'Avenir', 'Avenir Next', 'Nunito Sans', 'Helvetica Neue', sans-serif;
      font-size: 0.8rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.3s ease;
    }

    .travel-btn:hover, .capture-btn:hover {
      opacity: 1;
    }

    /* --- Info button (i) --- */
    .info-btn {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      width: 2.2rem;
      height: 2.2rem;
      border: none;
      background: none;
      cursor: pointer;
      padding: 0;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Georgia', 'Times New Roman', serif;
      font-size: 1.4rem;
      font-style: italic;
      color: inherit;
    }

    body.expanded .info-btn {
      opacity: 0.5;
      pointer-events: auto;
    }

    .info-btn:hover {
      opacity: 1;
    }

    .info-tooltip {
      position: fixed;
      bottom: 4.5rem;
      right: 1.5rem;
      width: 20rem;
      padding: 1.2rem 1.4rem;
      border-radius: 0.6rem;
      font-size: 0.8rem;
      line-height: 1.6;
      letter-spacing: 0.01em;
      opacity: 0;
      pointer-events: none;
      transform: translateY(6px);
      transition: opacity 0.3s ease, transform 0.3s ease, background-color 1s ease, color 1s ease;
    }

    .info-tooltip.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .info-tooltip strong {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      letter-spacing: 0.08em;
    }

    .info-tooltip p {
      margin-bottom: 0.6rem;
    }

    .info-tooltip p:last-child {
      margin-bottom: 0;
    }

    /* --- Card overlay --- */
    .card-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 100;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 1.2rem;
    }

    .card-overlay.visible {
      display: flex;
    }

    .card-canvas {
      max-width: 60vw;
      max-height: 55vh;
      border-radius: 0.4rem;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
    }

    .card-actions {
      display: flex;
      gap: 0.8rem;
      flex-shrink: 0;
    }

    .card-action-btn {
      padding: 0.6rem 1.6rem;
      border: 1.5px solid #f5f5f5;
      border-radius: 2rem;
      background: none;
      color: #f5f5f5;
      font-family: 'Avenir', 'Avenir Next', 'Nunito Sans', 'Helvetica Neue', sans-serif;
      font-size: 0.8rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.3s ease;
    }

    .card-action-btn:hover {
      opacity: 1;
    }

    .card-close {
      position: fixed;
      top: 1.2rem;
      right: 1.5rem;
      background: none;
      border: none;
      color: #f5f5f5;
      font-size: 2rem;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.3s ease;
      line-height: 1;
      z-index: 101;
    }

    .card-close:hover {
      opacity: 1;
    }

    @media (max-width: 600px) {
      .time { font-size: 3rem; }
      .container { padding: 2rem 1.5rem; }
      .colour-info { gap: 1.5rem; }
      .colour-value { font-size: 1.1rem; }
      .info-tooltip { width: 16rem; right: 1rem; bottom: 4rem; }
      .info-btn { bottom: 1rem; right: 1rem; }
      .logo-btn { width: 4rem; height: 4rem; top: calc(50% - 2rem); left: calc(50% - 2rem); }
      body.expanded .logo-btn { top: 0.8rem; left: 0.8rem; width: 2rem; height: 2rem; }
      .card-canvas { max-width: 70vw; max-height: 45vh; }
      .card-close { top: 0.8rem; right: 1rem; }
    }
  </style>
</head>
<body>
  <button class="logo-btn" id="logo-btn" aria-label="Toggle info"><img src="icon.svg" alt="Timetone"></button>

  <div class="container">
    <div class="time" id="time">00:00:00</div>
    <div class="date" id="date"></div>
    <div class="colour-info">
      <div class="colour-block">
        <span class="colour-label">HEX</span>
        <span class="colour-value" id="hex">#000000</span>
      </div>
      <div class="colour-block">
        <span class="colour-label">RGB</span>
        <span class="colour-value" id="rgb">0, 0, 0</span>
      </div>
      <div class="colour-block">
        <span class="colour-label">Pantone</span>
        <span class="colour-value" id="pantone">---</span>
      </div>
    </div>
    <div class="swatch-row">
      <div class="swatch" id="swatch-r"></div>
      <div class="swatch" id="swatch-g"></div>
      <div class="swatch" id="swatch-b"></div>
    </div>
    <div class="mapping">
      Day of Year &rarr; Hue &nbsp;&middot;&nbsp; Minutes &rarr; Saturation &nbsp;&middot;&nbsp; Time of Day &rarr; Lightness
    </div>
    <div class="btn-row">
      <button class="travel-btn" id="travel-btn">Travel in Color</button>
      <button class="capture-btn" id="capture-btn">Capture</button>
    </div>
  </div>

  <button class="info-btn" id="info-btn" aria-label="Information">i</button>
  <div class="info-tooltip" id="info-tooltip">
    <strong>Timetone</strong>
    <p>This page generates a unique colour from the current date and time, updated every second.</p>
    <p>The <em>day of the year</em> (1&ndash;366) sets the hue, rotating through the full colour spectrum over the calendar year. <em>Minutes</em> control the saturation (50&ndash;100%), and the <em>time of day</em> controls lightness (darker at midnight, brighter by evening).</p>
    <p>The resulting colour is displayed as HEX, RGB, and the nearest matching Pantone reference.</p>
  </div>

  <div class="card-overlay" id="card-overlay">
    <button class="card-close" id="card-close">&times;</button>
    <canvas id="card-canvas" width="1080" height="1350"></canvas>
    <div class="card-actions">
      <button class="card-action-btn" id="download-png">Download PNG</button>
      <button class="card-action-btn" id="download-pdf">Download PDF</button>
    </div>
  </div>

  <script>
    // Pantone colour reference table (subset of common Pantone Coated colours)
    const PANTONE = [
      { name: "Yellow C", r: 254, g: 221, b: 0 },
      { name: "Yellow 012 C", r: 255, g: 214, b: 0 },
      { name: "Orange 021 C", r: 254, g: 80, b: 0 },
      { name: "Warm Red C", r: 249, g: 66, b: 58 },
      { name: "Red 032 C", r: 239, g: 51, b: 64 },
      { name: "Rubine Red C", r: 206, g: 0, b: 88 },
      { name: "Rhodamine Red C", r: 225, g: 0, b: 152 },
      { name: "Purple C", r: 187, g: 41, b: 187 },
      { name: "Violet C", r: 68, g: 0, b: 153 },
      { name: "Blue 072 C", r: 16, g: 6, b: 159 },
      { name: "Reflex Blue C", r: 0, g: 20, b: 137 },
      { name: "Process Blue C", r: 0, g: 133, b: 202 },
      { name: "Green C", r: 0, g: 171, b: 132 },
      { name: "Black C", r: 45, g: 41, b: 38 },
      { name: "Cool Gray 1 C", r: 217, g: 214, b: 209 },
      { name: "Cool Gray 5 C", r: 177, g: 179, b: 179 },
      { name: "Cool Gray 9 C", r: 117, g: 120, b: 123 },
      { name: "Warm Gray 1 C", r: 215, g: 210, b: 203 },
      { name: "Warm Gray 5 C", r: 183, g: 176, b: 168 },
      { name: "185 C", r: 228, g: 0, b: 43 },
      { name: "186 C", r: 200, g: 16, b: 46 },
      { name: "199 C", r: 213, g: 43, b: 30 },
      { name: "1505 C", r: 255, g: 105, b: 0 },
      { name: "151 C", r: 255, g: 130, b: 0 },
      { name: "137 C", r: 255, g: 163, b: 0 },
      { name: "116 C", r: 255, g: 205, b: 0 },
      { name: "109 C", r: 255, g: 209, b: 0 },
      { name: "102 C", r: 252, g: 227, b: 0 },
      { name: "396 C", r: 225, g: 224, b: 0 },
      { name: "375 C", r: 151, g: 215, b: 0 },
      { name: "368 C", r: 120, g: 190, b: 32 },
      { name: "355 C", r: 0, g: 158, b: 73 },
      { name: "340 C", r: 0, g: 154, b: 120 },
      { name: "3272 C", r: 0, g: 171, b: 164 },
      { name: "3262 C", r: 0, g: 191, b: 179 },
      { name: "319 C", r: 43, g: 203, b: 186 },
      { name: "311 C", r: 0, g: 189, b: 227 },
      { name: "306 C", r: 0, g: 169, b: 224 },
      { name: "299 C", r: 0, g: 163, b: 224 },
      { name: "285 C", r: 0, g: 114, b: 206 },
      { name: "2728 C", r: 0, g: 71, b: 187 },
      { name: "2735 C", r: 47, g: 0, b: 135 },
      { name: "2685 C", r: 86, g: 0, b: 160 },
      { name: "2602 C", r: 135, g: 24, b: 157 },
      { name: "240 C", r: 196, g: 0, b: 171 },
      { name: "226 C", r: 214, g: 0, b: 147 },
      { name: "213 C", r: 234, g: 82, b: 161 },
      { name: "190 C", r: 237, g: 122, b: 155 },
      { name: "176 C", r: 240, g: 169, b: 181 },
      { name: "1767 C", r: 243, g: 186, b: 194 },
      { name: "7401 C", r: 245, g: 225, b: 164 },
      { name: "7402 C", r: 236, g: 219, b: 134 },
      { name: "7404 C", r: 245, g: 225, b: 0 },
      { name: "7405 C", r: 242, g: 205, b: 0 },
      { name: "7406 C", r: 241, g: 196, b: 0 },
      { name: "7408 C", r: 244, g: 176, b: 0 },
      { name: "7409 C", r: 237, g: 170, b: 0 },
      { name: "7410 C", r: 243, g: 164, b: 121 },
      { name: "7411 C", r: 229, g: 161, b: 79 },
      { name: "7412 C", r: 213, g: 144, b: 49 },
      { name: "7413 C", r: 226, g: 140, b: 0 },
      { name: "7414 C", r: 203, g: 135, b: 34 },
      { name: "7455 C", r: 63, g: 67, b: 173 },
      { name: "7456 C", r: 96, g: 94, b: 191 },
      { name: "7457 C", r: 193, g: 191, b: 226 },
      { name: "7462 C", r: 0, g: 61, b: 107 },
      { name: "7463 C", r: 0, g: 42, b: 78 },
      { name: "7473 C", r: 39, g: 137, b: 118 },
      { name: "7474 C", r: 0, g: 110, b: 117 },
      { name: "7475 C", r: 89, g: 139, b: 139 },
      { name: "7476 C", r: 0, g: 72, b: 77 },
      { name: "7481 C", r: 0, g: 185, b: 102 },
      { name: "7482 C", r: 0, g: 167, b: 80 },
      { name: "7483 C", r: 36, g: 88, b: 56 },
      { name: "7489 C", r: 116, g: 170, b: 80 },
      { name: "7490 C", r: 113, g: 151, b: 66 },
      { name: "7499 C", r: 242, g: 233, b: 187 },
      { name: "7500 C", r: 221, g: 212, b: 185 },
      { name: "7527 C", r: 217, g: 211, b: 198 },
      { name: "7528 C", r: 198, g: 190, b: 172 },
      { name: "7529 C", r: 180, g: 172, b: 154 },
      { name: "7530 C", r: 162, g: 155, b: 140 },
      { name: "7531 C", r: 120, g: 112, b: 101 },
      { name: "7532 C", r: 99, g: 90, b: 76 },
      { name: "7533 C", r: 59, g: 48, b: 36 },
      { name: "7534 C", r: 210, g: 203, b: 186 },
      { name: "7535 C", r: 177, g: 172, b: 152 },
      { name: "7536 C", r: 163, g: 158, b: 135 },
      { name: "7541 C", r: 213, g: 223, b: 227 },
      { name: "7542 C", r: 166, g: 187, b: 200 },
      { name: "7543 C", r: 152, g: 168, b: 179 },
      { name: "7544 C", r: 118, g: 139, b: 155 },
      { name: "7545 C", r: 66, g: 85, b: 99 },
      { name: "7546 C", r: 37, g: 55, b: 70 },
      { name: "7547 C", r: 19, g: 33, b: 45 },
    ];

    function nearestPantone(r, g, b) {
      let best = PANTONE[0];
      let bestDist = Infinity;
      for (const p of PANTONE) {
        const dr = r - p.r;
        const dg = g - p.g;
        const db = b - p.b;
        const dist = 2 * dr * dr + 4 * dg * dg + 3 * db * db;
        if (dist < bestDist) {
          bestDist = dist;
          best = p;
        }
      }
      return best.name;
    }

    function toHex(n) {
      return n.toString(16).padStart(2, '0').toUpperCase();
    }

    function luminance(r, g, b) {
      return 0.299 * r + 0.587 * g + 0.114 * b;
    }

    function dayOfYear(date) {
      const start = new Date(date.getFullYear(), 0, 0);
      const diff = date - start;
      return Math.floor(diff / 86400000);
    }

    function hslToRgb(h, s, l) {
      h = ((h % 360) + 360) % 360;
      const c = (1 - Math.abs(2 * l - 1)) * s;
      const x = c * (1 - Math.abs((h / 60) % 2 - 1));
      const m = l - c / 2;
      let r1, g1, b1;
      if (h < 60)       { r1 = c; g1 = x; b1 = 0; }
      else if (h < 120) { r1 = x; g1 = c; b1 = 0; }
      else if (h < 180) { r1 = 0; g1 = c; b1 = x; }
      else if (h < 240) { r1 = 0; g1 = x; b1 = c; }
      else if (h < 300) { r1 = x; g1 = 0; b1 = c; }
      else              { r1 = c; g1 = 0; b1 = x; }
      return [
        Math.round((r1 + m) * 255),
        Math.round((g1 + m) * 255),
        Math.round((b1 + m) * 255),
      ];
    }

    function updateTime() {
      const now = new Date();
      const h = now.getHours();
      const m = now.getMinutes();
      const s = now.getSeconds();
      const pad = n => String(n).padStart(2, '0');
      document.getElementById('time').textContent =
        `${pad(h)}:${pad(m)}:${pad(s)}`;

      const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('date').textContent =
        now.toLocaleDateString('en-GB', opts);
    }

    function updateColour() {
      const now = new Date();
      const h = now.getHours();
      const m = now.getMinutes();
      const s = now.getSeconds();
      const doy = dayOfYear(now);
      const daysInYear = ((now.getFullYear() % 4 === 0 &&
        now.getFullYear() % 100 !== 0) || now.getFullYear() % 400 === 0)
        ? 366 : 365;

      const yearOffset = (now.getFullYear() * 137.508) % 360;
      const dayOffset = (doy * 47.1) % 360;
      const minuteOfDay = h * 60 + m;
      const currentHue = (minuteOfDay * 137.508 + yearOffset + dayOffset) % 360;
      const nextHue = ((minuteOfDay + 1) * 137.508 + yearOffset + dayOffset) % 360;
      let hueDelta = nextHue - currentHue;
      if (hueDelta > 180) hueDelta -= 360;
      if (hueDelta < -180) hueDelta += 360;
      const hue = ((currentHue + hueDelta * (s / 60)) % 360 + 360) % 360;
      const timeSeconds = h * 3600 + m * 60 + s;
      const saturation = 0.5 + 0.5 * (m / 59);
      const lightness  = 0.25 + 0.5 * (timeSeconds / 86399);

      const [r, g, b] = hslToRgb(hue, saturation, lightness);

      const hex = `#${toHex(r)}${toHex(g)}${toHex(b)}`;
      const pantone = nearestPantone(r, g, b);
      const lum = luminance(r, g, b);
      const textColour = lum > 140 ? '#111' : '#f5f5f5';

      const tooltipBg = lum > 140 ? '#222' : '#f0f0f0';
      const tooltipText = lum > 140 ? '#f5f5f5' : '#111';

      document.body.style.backgroundColor = hex;
      document.querySelector('.container').style.color = textColour;
      document.querySelector('.info-btn').style.color = textColour;
      const tooltip = document.getElementById('info-tooltip');
      tooltip.style.color = tooltipText;
      tooltip.style.backgroundColor = tooltipBg;

      document.getElementById('hex').textContent = hex;
      document.getElementById('rgb').textContent = `${r}, ${g}, ${b}`;
      document.getElementById('pantone').textContent = pantone;

      document.getElementById('swatch-r').style.backgroundColor = `rgb(${r},0,0)`;
      document.getElementById('swatch-g').style.backgroundColor = `rgb(0,${g},0)`;
      document.getElementById('swatch-b').style.backgroundColor = `rgb(0,0,${b})`;

      // Store current values for capture
      window._tt = { r, g, b, hex, pantone, lum,
        time: document.getElementById('time').textContent,
        date: document.getElementById('date').textContent,
        rgb: `${r}, ${g}, ${b}` };
    }

    updateTime();
    updateColour();
    setInterval(updateTime, 1000);
    setInterval(updateColour, 1000);

    // Logo toggle
    document.getElementById('logo-btn').addEventListener('click', () => {
      document.body.classList.toggle('expanded');
      if (!document.body.classList.contains('expanded')) {
        document.getElementById('info-tooltip').classList.remove('visible');
      }
    });

    // Info tooltip
    const infoBtn = document.getElementById('info-btn');
    const infoTooltip = document.getElementById('info-tooltip');
    infoBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      infoTooltip.classList.toggle('visible');
    });
    document.addEventListener('click', (e) => {
      if (!infoTooltip.contains(e.target) && !infoBtn.contains(e.target)) {
        infoTooltip.classList.remove('visible');
      }
    });

    // Travel
    document.getElementById('travel-btn').addEventListener('click', () => {
      window.location.href = 'calendar.html';
    });

    // --- Capture card ---
    const cardOverlay = document.getElementById('card-overlay');
    const cardCanvas = document.getElementById('card-canvas');
    const logoImg = new Image();
    logoImg.src = 'icon.svg';

    function drawCard(data) {
      const W = 1080, H = 1080;
      cardCanvas.width = W;
      cardCanvas.height = H;
      const ctx = cardCanvas.getContext('2d');

      // Background
      ctx.fillStyle = data.hex;
      ctx.fillRect(0, 0, W, H);

      const textCol = data.lum > 140 ? '#111' : '#f5f5f5';
      const subCol = data.lum > 140 ? 'rgba(0,0,0,0.45)' : 'rgba(255,255,255,0.45)';
      ctx.textAlign = 'center';

      // Logo
      const logoSize = 100;
      ctx.drawImage(logoImg, (W - logoSize) / 2, 70, logoSize, logoSize);

      // "Here is your Timetone"
      ctx.fillStyle = subCol;
      ctx.font = '300 38px Avenir, "Avenir Next", "Nunito Sans", "Helvetica Neue", sans-serif';
      ctx.letterSpacing = '4px';
      ctx.fillText('Here is your Timetone', W / 2, 230);

      // Time
      ctx.fillStyle = textCol;
      ctx.font = 'bold 160px Avenir, "Avenir Next", "Nunito Sans", "Helvetica Neue", sans-serif';
      ctx.letterSpacing = '8px';
      ctx.fillText(data.time, W / 2, 390);

      // Date
      ctx.fillStyle = subCol;
      ctx.font = '300 36px Avenir, "Avenir Next", "Nunito Sans", "Helvetica Neue", sans-serif';
      ctx.letterSpacing = '6px';
      ctx.fillText(data.date.toUpperCase(), W / 2, 450);

      // Colour values â€” horizontal row
      const labels = ['HEX', 'RGB', 'PANTONE'];
      const values = [data.hex, data.rgb, data.pantone];
      const colX = [W / 2 - 300, W / 2, W / 2 + 300];

      for (let i = 0; i < 3; i++) {
        ctx.fillStyle = subCol;
        ctx.font = '300 28px Avenir, "Avenir Next", "Nunito Sans", "Helvetica Neue", sans-serif';
        ctx.letterSpacing = '6px';
        ctx.fillText(labels[i], colX[i], 560);

        ctx.fillStyle = textCol;
        ctx.font = 'bold 42px Avenir, "Avenir Next", "Nunito Sans", "Helvetica Neue", sans-serif';
        ctx.letterSpacing = '2px';
        ctx.fillText(values[i], colX[i], 610);
      }

      // Divider
      ctx.strokeStyle = subCol;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(W / 2 - 200, 670);
      ctx.lineTo(W / 2 + 200, 670);
      ctx.stroke();

      // Mapping description
      ctx.fillStyle = subCol;
      ctx.font = '300 24px Avenir, "Avenir Next", "Nunito Sans", "Helvetica Neue", sans-serif';
      ctx.letterSpacing = '3px';
      ctx.fillText('Day \u2192 Hue  \u00B7  Minutes \u2192 Saturation  \u00B7  Time \u2192 Lightness', W / 2, 720);

      // Footer
      ctx.font = '300 26px Avenir, "Avenir Next", "Nunito Sans", "Helvetica Neue", sans-serif';
      ctx.letterSpacing = '5px';
      ctx.fillText('TIMETONE.NONEED.DEV', W / 2, H - 50);
    }

    document.getElementById('capture-btn').addEventListener('click', () => {
      if (!window._tt) return;
      drawCard(window._tt);
      cardOverlay.classList.add('visible');
    });

    document.getElementById('card-close').addEventListener('click', () => {
      cardOverlay.classList.remove('visible');
    });

    cardOverlay.addEventListener('click', (e) => {
      if (e.target === cardOverlay) cardOverlay.classList.remove('visible');
    });

    // Download PNG
    document.getElementById('download-png').addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = `timetone-${window._tt.time.replace(/:/g, '')}.png`;
      link.href = cardCanvas.toDataURL('image/png');
      link.click();
    });

    // Download PDF (canvas image embedded in minimal PDF)
    document.getElementById('download-pdf').addEventListener('click', () => {
      const jpegDataUrl = cardCanvas.toDataURL('image/jpeg', 0.95);
      const jpegBase64 = jpegDataUrl.split(',')[1];
      const jpegBin = atob(jpegBase64);

      const imgW = cardCanvas.width;
      const imgH = cardCanvas.height;
      // Fit to A4 width
      const pageW = 595.28;
      const pageH = pageW * (imgH / imgW);

      const enc = new TextEncoder();
      const parts = [];
      const push = (s) => parts.push(enc.encode(s));
      const pushBin = (bin) => {
        const a = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) a[i] = bin.charCodeAt(i);
        parts.push(a);
      };
      const offset = () => parts.reduce((s, p) => s + p.length, 0);

      push('%PDF-1.4\n');
      const xref = [];

      xref.push(offset());
      push('1 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n');

      xref.push(offset());
      push('2 0 obj\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\nendobj\n');

      xref.push(offset());
      push(`3 0 obj\n<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${pageW.toFixed(2)} ${pageH.toFixed(2)}] /Contents 4 0 R /Resources << /XObject << /Img 5 0 R >> >> >>\nendobj\n`);

      const stream = `q ${pageW.toFixed(2)} 0 0 ${pageH.toFixed(2)} 0 0 cm /Img Do Q`;
      xref.push(offset());
      push(`4 0 obj\n<< /Length ${stream.length} >>\nstream\n${stream}\nendstream\nendobj\n`);

      xref.push(offset());
      push(`5 0 obj\n<< /Type /XObject /Subtype /Image /Width ${imgW} /Height ${imgH} /ColorSpace /DeviceRGB /BitsPerComponent 8 /Filter /DCTDecode /Length ${jpegBin.length} >>\nstream\n`);
      pushBin(jpegBin);
      push('\nendstream\nendobj\n');

      const xrefOff = offset();
      push('xref\n');
      push(`0 ${xref.length + 1}\n`);
      push('0000000000 65535 f \n');
      for (const o of xref) push(String(o).padStart(10, '0') + ' 00000 n \n');

      push('trailer\n');
      push(`<< /Size ${xref.length + 1} /Root 1 0 R >>\n`);
      push('startxref\n');
      push(`${xrefOff}\n`);
      push('%%EOF\n');

      const total = parts.reduce((s, p) => s + p.length, 0);
      const pdf = new Uint8Array(total);
      let pos = 0;
      for (const p of parts) { pdf.set(p, pos); pos += p.length; }

      const blob = new Blob([pdf], { type: 'application/pdf' });
      const link = document.createElement('a');
      link.download = `timetone-${window._tt.time.replace(/:/g, '')}.pdf`;
      link.href = URL.createObjectURL(blob);
      link.click();
      URL.revokeObjectURL(link.href);
    });
  </script>
</body>
</html>
